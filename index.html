<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Talking Rabbit</title>
    <meta name="theme-color" content="#f093fb">
    
    <!-- BANAR AD CODE START -->
    <script>
      atOptions = {
        'key' : 'a14a2842afcaf02a4fca4ffc3031e4ee',
        'format' : 'iframe',
        'height' : 60,
        'width' : 468,
        'params' : {}
      };
    </script>
    <script src="https://www.highperformanceformat.com/a14a2842afcaf02a4fca4ffc3031e4ee/invoke.js"></script>
    <!-- BANAR AD CODE END -->

    <style>
        /* --- GLOBAL STYLES --- */
        * {
            box-sizing: border-box;
            user-select: none;
            -webkit-user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            font-family: 'Comic Sans MS', 'Chalkboard SE', 'Comic Neue', sans-serif;
            background-color: #000;
        }

        /* --- WELCOME SCREEN --- */
        #welcome-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            transition: opacity 0.5s ease;
        }

        .welcome-img {
            width: 90%;
            max-width: 400px;
            border-radius: 30px;
            border: 8px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: float 3s ease-in-out infinite;
            margin-bottom: 40px;
            object-fit: cover;
        }

        .play-btn {
            position: relative;
            padding: 15px 60px;
            font-size: 32px;
            font-weight: bold;
            color: white;
            text-transform: uppercase;
            background: linear-gradient(to bottom, #ff69b4, #ff1493);
            border: none;
            border-radius: 60px;
            box-shadow: 
                inset 0 4px 10px rgba(255,255,255,0.4),
                0 10px 20px rgba(0,0,0,0.2),
                0 0 20px rgba(255, 20, 147, 0.6);
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
            cursor: pointer;
            overflow: hidden;
            animation: pulse-btn 2s infinite;
        }

        /* Ripple Effect */
        .ripple {
            position: absolute;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 50%;
            transform: scale(0);
            animation: ripple-anim 0.6s linear;
            pointer-events: none;
        }

        /* --- MAIN APP SCREEN --- */
        #app-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to bottom, #a8edea, #fed6e3);
            display: none; /* Hidden initially */
            opacity: 0;
            transition: opacity 0.5s ease;
        }

        /* Video Container */
        #video-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        video.active {
            opacity: 1;
            z-index: 2;
        }

        /* --- TAP ZONES --- */
        .tap-zone {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10;
            /* border: 2px solid rgba(255,0,0,0.3); Debug: visible zones */
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
        }

        #zone-head {
            top: 15%;
            width: 150px;
            height: 150px;
            border-radius: 50%;
        }

        #zone-body {
            top: 40%;
            width: 180px;
            height: 200px;
            border-radius: 50%;
        }

        #zone-feet {
            bottom: 25%;
            width: 200px;
            height: 100px;
            border-radius: 50%;
        }

        /* --- STATUS BADGE --- */
        #status-badge {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #a78bfa, #8b5cf6);
            color: white;
            padding: 8px 20px;
            border-radius: 20px;
            font-size: 18px;
            font-weight: bold;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            z-index: 20;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
            white-space: nowrap;
        }

        /* --- CONTROLS --- */
        #controls {
            position: absolute;
            bottom: 30px;
            left: 0;
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: flex-end;
            gap: 25px;
            z-index: 20;
            padding-bottom: env(safe-area-inset-bottom);
        }

        .ctrl-btn {
            border: none;
            border-radius: 50%;
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 35px;
            box-shadow: 
                inset 0 4px 8px rgba(255,255,255,0.4),
                0 6px 0 rgba(0,0,0,0.2),
                0 10px 10px rgba(0,0,0,0.2);
            transition: transform 0.1s;
            cursor: pointer;
        }

        .ctrl-btn:active {
            transform: translateY(4px);
            box-shadow: inset 0 4px 8px rgba(0,0,0,0.2), 0 2px 0 rgba(0,0,0,0.2);
        }

        #btn-laugh {
            width: 80px;
            height: 80px;
            background: linear-gradient(to bottom, #fbbf24, #f59e0b);
            border-bottom: 5px solid #d97706;
        }

        #btn-music {
            width: 80px;
            height: 80px;
            background: linear-gradient(to bottom, #a78bfa, #8b5cf6);
            border-bottom: 5px solid #7c3aed;
        }

        #btn-mic {
            width: 90px;
            height: 90px;
            background: linear-gradient(to bottom, #ff69b4, #ff1493);
            border-bottom: 6px solid #db2777;
            position: relative;
            margin-bottom: 10px;
        }

        /* CSS Mic Icon */
        .mic-icon {
            width: 24px;
            height: 36px;
            background: white;
            border-radius: 12px;
            position: relative;
        }
        .mic-icon::before {
            content: '';
            position: absolute;
            top: 20px;
            left: -4px;
            width: 32px;
            height: 20px;
            border-radius: 0 0 16px 16px;
            border: 4px solid white;
            border-top: none;
        }
        .mic-icon::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 10px;
            width: 4px;
            height: 10px;
            background: white;
        }
        .mic-base {
            position: absolute;
            bottom: 27px;
            width: 16px;
            height: 4px;
            background: white;
            border-radius: 2px;
        }

        /* --- ANIMATIONS --- */
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }

        @keyframes pulse-btn {
            0% { transform: scale(1); }
            50% { transform: scale(1.08); box-shadow: 0 0 30px rgba(255, 20, 147, 0.8); }
            100% { transform: scale(1); }
        }

        @keyframes ripple-anim {
            to { transform: scale(4); opacity: 0; }
        }

        @keyframes listening-pulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(167, 139, 250, 0.7); }
            70% { transform: scale(1.1); box-shadow: 0 0 0 20px rgba(167, 139, 250, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(167, 139, 250, 0); }
        }

        @keyframes speaking-glow {
            0% { box-shadow: 0 0 20px #fbbf24; }
            50% { box-shadow: 0 0 40px #f59e0b; }
            100% { box-shadow: 0 0 20px #fbbf24; }
        }

        @keyframes fall {
            0% { top: -50px; transform: rotate(0deg); opacity: 1; }
            100% { top: 100vh; transform: rotate(360deg); opacity: 0; }
        }

        @keyframes floatUp {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translateY(-100px) scale(1.5); opacity: 0; }
        }

        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            10% { transform: translate(-1px, -2px) rotate(-1deg); }
            20% { transform: translate(-3px, 0px) rotate(1deg); }
            30% { transform: translate(3px, 2px) rotate(0deg); }
            40% { transform: translate(1px, -1px) rotate(1deg); }
            50% { transform: translate(-1px, 2px) rotate(-1deg); }
            60% { transform: translate(-3px, 1px) rotate(0deg); }
            70% { transform: translate(3px, 1px) rotate(-1deg); }
            80% { transform: translate(-1px, -1px) rotate(1deg); }
            90% { transform: translate(1px, 2px) rotate(0deg); }
            100% { transform: translate(1px, -2px) rotate(-1deg); }
        }

        .shake-screen {
            animation: shake 0.5s;
        }

        /* --- PARTICLES --- */
        .emoji-particle {
            position: absolute;
            font-size: 30px;
            pointer-events: none;
            z-index: 15;
        }

        /* --- EXIT MODAL --- */
        #exit-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .modal-content {
            background: linear-gradient(135deg, #a78bfa, #8b5cf6);
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            width: 80%;
            max-width: 320px;
            border: 4px solid white;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        .modal-content h2 {
            color: white;
            margin-top: 0;
            font-size: 24px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .modal-btns {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
        }

        .modal-btn {
            padding: 10px 30px;
            border-radius: 30px;
            border: none;
            font-weight: bold;
            font-size: 18px;
            cursor: pointer;
            box-shadow: 0 4px 0 rgba(0,0,0,0.2);
        }

        .btn-yes { background: #ff69b4; color: white; }
        .btn-no { background: #22d3ee; color: white; }

        /* --- RESPONSIVE ADJUSTMENTS --- */
        @media (max-width: 600px) {
            #btn-laugh, #btn-music { width: 70px; height: 70px; font-size: 30px; }
            #btn-mic { width: 80px; height: 80px; }
            .welcome-img { width: 320px; }
        }

        @media (max-width: 400px) {
            #btn-laugh, #btn-music { width: 60px; height: 60px; font-size: 24px; }
            #btn-mic { width: 70px; height: 70px; }
            .mic-icon { transform: scale(0.8); }
            #controls { gap: 15px; }
            .play-btn { padding: 12px 40px; font-size: 24px; }
            .welcome-img { width: 280px; }
        }
    </style>
</head>
<body>

    <!-- WELCOME SCREEN -->
    <div id="welcome-screen">
        <img src="tom_welcome.jpg" alt="Welcome" class="welcome-img" id="welcome-img">
        <button class="play-btn" id="start-btn">
            &#9654; Play
        </button>
    </div>

    <!-- MAIN APP SCREEN -->
    <div id="app-screen">
        
        <!-- Video Backgrounds -->
        <div id="video-container">
            <!-- Loop Idle -->
            <video id="vid-standing" src="tom_standing.mp4" loop playsinline muted preload="auto"></video>
            <!-- Listening -->
            <video id="vid-listening" src="tom_listing.mp4" loop playsinline muted preload="auto"></video>
            <!-- Talking -->
            <video id="vid-talking" src="tom_talking.mp4" loop playsinline muted preload="auto"></video>
            <!-- Laughing -->
            <video id="vid-laughing" src="laughing.mp4" loop playsinline muted preload="auto"></video>
            <!-- Music -->
            <video id="vid-music" src="music.mp4" loop playsinline muted preload="auto"></video>
        </div>

        <!-- Status Indicator -->
        <div id="status-badge">Hello Friend!</div>

        <!-- Tap Zones -->
        <div id="tap-zones">
            <div id="zone-head" class="tap-zone"></div>
            <div id="zone-body" class="tap-zone"></div>
            <div id="zone-feet" class="tap-zone"></div>
        </div>

        <!-- Controls -->
        <div id="controls">
            <button id="btn-laugh" class="ctrl-btn">&#128516;</button>
            <button id="btn-mic" class="ctrl-btn">
                <div class="mic-icon"></div>
                <div class="mic-base"></div>
            </button>
            <button id="btn-music" class="ctrl-btn">&#127925;</button>
        </div>
    </div>

    <!-- PARTICLE CONTAINER -->
    <div id="particles-container"></div>

    <!-- HIDDEN AUDIO FOR LOOPS (Music/Laugh) -->
    <audio id="sfx-laugh" src="laughing.wav" preload="auto"></audio>
    <audio id="sfx-music" src="music.wav" preload="auto"></audio>

    <!-- EXIT MODAL -->
    <div id="exit-modal">
        <div class="modal-content">
            <h2>Do you want to exit?</h2>
            <div class="modal-btns">
                <button class="modal-btn btn-yes" id="exit-yes">Yes</button>
                <button class="modal-btn btn-no" id="exit-no">No</button>
            </div>
        </div>
    </div>

    <script>
        // --- STATE MANAGEMENT ---
        const AppState = {
            WELCOME: 'WELCOME',
            IDLE: 'IDLE',
            LISTENING: 'LISTENING',
            TALKING: 'TALKING',
            LAUGHING: 'LAUGHING',
            MUSIC: 'MUSIC'
        };

        let currentState = AppState.WELCOME;
        let audioContext = null;
        let mediaRecorder = null;
        let audioChunks = [];
        let sfxPlayCount = 0;
        let recordingTimeout = null;

        // --- DOM ELEMENTS ---
        const welcomeScreen = document.getElementById('welcome-screen');
        const appScreen = document.getElementById('app-screen');
        const startBtn = document.getElementById('start-btn');
        const statusBadge = document.getElementById('status-badge');
        
        const videos = {
            standing: document.getElementById('vid-standing'),
            listening: document.getElementById('vid-listening'),
            talking: document.getElementById('vid-talking'),
            laughing: document.getElementById('vid-laughing'),
            music: document.getElementById('vid-music')
        };

        const btnLaugh = document.getElementById('btn-laugh');
        const btnMic = document.getElementById('btn-mic');
        const btnMusic = document.getElementById('btn-music');
        
        const sfxLaugh = document.getElementById('sfx-laugh');
        const sfxMusic = document.getElementById('sfx-music');

        const exitModal = document.getElementById('exit-modal');
        const btnExitYes = document.getElementById('exit-yes');
        const btnExitNo = document.getElementById('exit-no');

        // --- INITIALIZATION ---
        
        function initAudioContext() {
            if (!audioContext) {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                audioContext = new AudioContext();
            }
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }
        }

        startBtn.addEventListener('click', (e) => {
            // Ripple Effect
            const circle = document.createElement('span');
            const diameter = Math.max(startBtn.clientWidth, startBtn.clientHeight);
            const radius = diameter / 2;
            circle.style.width = circle.style.height = `${diameter}px`;
            circle.style.left = `${e.clientX - startBtn.offsetLeft - radius}px`;
            circle.style.top = `${e.clientY - startBtn.offsetTop - radius}px`;
            circle.classList.add('ripple');
            startBtn.appendChild(circle);

            initAudioContext();

            // Transition
            setTimeout(() => {
                welcomeScreen.style.opacity = '0';
                setTimeout(() => {
                    welcomeScreen.style.display = 'none';
                    appScreen.style.display = 'block';
                    
                    // Force Layout Calc
                    void appScreen.offsetWidth; 
                    
                    appScreen.style.opacity = '1';
                    switchState(AppState.IDLE);
                    
                    // History API for Back Button
                    history.pushState({ page: 'app' }, 'Talking Rabbit', '#app');
                }, 500);
            }, 400);
        });

        // --- STATE & VIDEO LOGIC ---

        function switchVideo(videoKey) {
            Object.values(videos).forEach(v => {
                v.classList.remove('active');
                v.pause();
                v.currentTime = 0;
            });
            const target = videos[videoKey];
            target.classList.add('active');
            target.play().catch(e => console.log("Video play error:", e));
        }

        function switchState(newState) {
            currentState = newState;
            
            // Reset button visuals
            btnMic.style.animation = 'none';
            btnMic.style.background = 'linear-gradient(to bottom, #ff69b4, #ff1493)';

            switch(newState) {
                case AppState.IDLE:
                    switchVideo('standing');
                    showStatus("");
                    break;
                case AppState.LISTENING:
                    switchVideo('listening');
                    btnMic.style.background = 'linear-gradient(to bottom, #a78bfa, #8b5cf6)';
                    btnMic.style.animation = 'listening-pulse 1.5s infinite';
                    showStatus("Listening...");
                    break;
                case AppState.TALKING:
                    switchVideo('talking');
                    btnMic.style.background = '#fbbf24';
                    btnMic.style.animation = 'speaking-glow 1s infinite';
                    showStatus("Rabbit Speaking...");
                    break;
                case AppState.LAUGHING:
                    switchVideo('laughing');
                    showStatus("Ha ha ha ha!");
                    break;
                case AppState.MUSIC:
                    switchVideo('music');
                    showStatus("Let's Dance!");
                    break;
            }
        }

        function showStatus(text) {
            if(!text) {
                statusBadge.style.opacity = '0';
                return;
            }
            statusBadge.textContent = text;
            statusBadge.style.opacity = '1';
        }

        // --- INTERACTIVE FEATURES (Tap Zones) ---

        const tapMessages = ["Hehe! That tickles!", "Ha ha ha!", "Stop it! Haha!", "Ooh!", "Yay!"];
        const emojis = ['â­', 'ðŸ’«', 'âœ¨', 'ðŸŒŸ', 'ðŸ’¥', 'â¤ï¸', 'ðŸ’›', 'ðŸ’š', 'ðŸ’™', 'ðŸ’œ'];

        function handleTapZone() {
            if(currentState !== AppState.IDLE) return;

            // Vibration
            if(navigator.vibrate) navigator.vibrate(50);

            // Screen Shake
            document.body.classList.add('shake-screen');
            setTimeout(() => document.body.classList.remove('shake-screen'), 500);

            // Random Message
            const msg = tapMessages[Math.floor(Math.random() * tapMessages.length)];
            showStatus(msg);
            setTimeout(() => { if(currentState === AppState.IDLE) showStatus(""); }, 1500);

            // Particles
            createTapParticles();
        }

        function createTapParticles() {
            for(let i=0; i<8; i++) {
                const el = document.createElement('div');
                el.classList.add('emoji-particle');
                el.textContent = emojis[Math.floor(Math.random() * emojis.length)];
                
                // Random position near center/click
                const left = 50 + (Math.random() * 40 - 20);
                const top = 40 + (Math.random() * 40 - 20);
                
                el.style.left = left + '%';
                el.style.top = top + '%';
                el.style.animation = `floatUp 1.5s ease-out forwards`;
                
                document.getElementById('particles-container').appendChild(el);
                setTimeout(() => el.remove(), 1500);
            }
        }

        document.getElementById('zone-head').addEventListener('click', handleTapZone);
        document.getElementById('zone-body').addEventListener('click', handleTapZone);
        document.getElementById('zone-feet').addEventListener('click', handleTapZone);

        // --- BUTTON FEATURES ---

        // 1. Laughing
        btnLaugh.addEventListener('click', () => {
            if(currentState !== AppState.IDLE) return;
            switchState(AppState.LAUGHING);
            startFallingEmojis('ðŸ˜‚');
            
            sfxPlayCount = 0;
            sfxLaugh.currentTime = 0;
            sfxLaugh.play();
            
            sfxLaugh.onended = () => {
                sfxPlayCount++;
                if(sfxPlayCount < 2) {
                    sfxLaugh.play();
                } else {
                    switchState(AppState.IDLE);
                }
            };
        });

        // 3. Music
        btnMusic.addEventListener('click', () => {
            if(currentState !== AppState.IDLE) return;
            switchState(AppState.MUSIC);
            startFallingEmojis('ðŸŽµ');

            sfxPlayCount = 0;
            sfxMusic.currentTime = 0;
            sfxMusic.play();

            sfxMusic.onended = () => {
                sfxPlayCount++;
                if(sfxPlayCount < 2) {
                    sfxMusic.play();
                } else {
                    switchState(AppState.IDLE);
                }
            };
        });

        // Falling Emojis Logic
        function startFallingEmojis(char) {
            const container = document.getElementById('particles-container');
            for(let i=0; i<15; i++) {
                setTimeout(() => {
                    const el = document.createElement('div');
                    el.classList.add('emoji-particle');
                    el.textContent = char;
                    el.style.left = Math.random() * 100 + '%';
                    el.style.animation = `fall 4s linear forwards`;
                    container.appendChild(el);
                    setTimeout(() => el.remove(), 4000);
                }, i * 200);
            }
        }

        // 2. Mic / Recording (Pitch Shift)
        btnMic.addEventListener('click', async () => {
            if(currentState !== AppState.IDLE) return;

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: { 
                        echoCancellation: true, 
                        noiseSuppression: true, 
                        autoGainControl: true 
                    } 
                });

                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];

                mediaRecorder.ondataavailable = (event) => {
                    audioChunks.push(event.data);
                };

                mediaRecorder.onstop = async () => {
                    switchState(AppState.TALKING);
                    const audioBlob = new Blob(audioChunks);
                    const arrayBuffer = await audioBlob.arrayBuffer();
                    const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);

                    const source = audioContext.createBufferSource();
                    source.buffer = audioBuffer;
                    source.playbackRate.value = 1.5; // Pitch shift up
                    source.connect(audioContext.destination);
                    
                    source.onended = () => {
                        switchState(AppState.IDLE);
                    };

                    source.start();
                };

                // Start Recording
                switchState(AppState.LISTENING);
                mediaRecorder.start();

                // Stop automatically after 5 seconds
                recordingTimeout = setTimeout(() => {
                    if(mediaRecorder && mediaRecorder.state === 'recording') {
                        mediaRecorder.stop();
                    }
                }, 5000);

            } catch (err) {
                console.error("Mic Error:", err);
                showStatus("Mic Permission Denied");
                setTimeout(() => switchState(AppState.IDLE), 2000);
            }
        });

        // --- BACK BUTTON & EXIT DIALOG ---

        window.addEventListener('popstate', (event) => {
            if (currentState === AppState.WELCOME) return; // Ignore on initial load

            // Show Dialog
            exitModal.style.display = 'flex';
        });

        btnExitNo.addEventListener('click', () => {
            exitModal.style.display = 'none';
            // Push state again so back button works next time
            history.pushState({ page: 'app' }, 'Talking Rabbit', '#app');
        });

        btnExitYes.addEventListener('click', () => {
            exitModal.style.display = 'none';
            // Stop any playing media
            Object.values(videos).forEach(v => v.pause());
            sfxLaugh.pause();
            sfxMusic.pause();
            
            // Return to Welcome
            appScreen.style.opacity = '0';
            setTimeout(() => {
                appScreen.style.display = 'none';
                welcomeScreen.style.display = 'flex';
                welcomeScreen.style.opacity = '1';
                currentState = AppState.WELCOME;
            }, 500);
        });

    </script>
</body>
</html>
